"use strict";var ApplicationConfiguration=function(){var applicationModuleName="lpa",applicationModuleVendorDependencies=["ngResource","ngAnimate","ngSanitize","ui.router","ui.bootstrap","ui.utils","pascalprecht.translate","ui.select","angulartics","angulartics.google.analytics"],registerModule=function(moduleName,dependencies){angular.module(moduleName,dependencies||[]),angular.module(applicationModuleName).requires.push(moduleName)};return{applicationModuleName:applicationModuleName,applicationModuleVendorDependencies:applicationModuleVendorDependencies,registerModule:registerModule}}();angular.module(ApplicationConfiguration.applicationModuleName,ApplicationConfiguration.applicationModuleVendorDependencies),angular.module(ApplicationConfiguration.applicationModuleName).config(["$locationProvider",function($locationProvider){$locationProvider.hashPrefix("!")}]),angular.element(document).ready(function(){"#_=_"===window.location.hash&&(window.location.hash="#!"),angular.bootstrap(document,[ApplicationConfiguration.applicationModuleName])}),ApplicationConfiguration.registerModule("core"),ApplicationConfiguration.registerModule("protocols"),ApplicationConfiguration.registerModule("users"),angular.module("core").config(["$analyticsProvider",function($analyticsProvider){$analyticsProvider.virtualPageviews(!1)}]),angular.module("core").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$urlRouterProvider.otherwise("/"),$stateProvider.state("home",{url:"/",templateUrl:"modules/core/views/home.client.view.html"})}]),angular.module("core").config(["$translateProvider",function($translateProvider){$translateProvider.useStaticFilesLoader({prefix:"i18n/locale-",suffix:".json"}),$translateProvider.preferredLanguage("si_SL"),$translateProvider.useSanitizeValueStrategy("escaped")}]),angular.module("core").controller("HeaderController",["$scope","$state","Authentication","Menus","$translate",function($scope,$state,Authentication,Menus,$translate){$scope.$state=$state,$scope.authentication=Authentication,$scope.isCollapsed=!1,$scope.menu=Menus.getMenu("topbar"),$scope.toggleCollapsibleMenu=function(){$scope.isCollapsed=!$scope.isCollapsed},$scope.toggleLanguage=function(){$translate.use("en_EN"===$translate.use()?"si_SL":"en_EN")},$scope.$on("$stateChangeSuccess",function(){$scope.isCollapsed=!1})}]),angular.module("core").controller("HomeController",["$scope","Authentication",function($scope,Authentication){$scope.authentication=Authentication}]),angular.module("core").directive("panelDraggable",["$document",function($document){return{restrict:"C",link:function(scope,element,attr){function mousemove(e){y=e.screenY-startY,x=e.screenX-startX,element.css({top:y+"px",left:x+"px"})}function mouseup(e){y=1*element.css("top").replace("px",""),x=1*element.css("left").replace("px",""),y=0>y?0:y,x=0>x?0:x,element.css({top:y+"px",left:x+"px"}),$document.off("mousemove",mousemove),$document.off("mouseup",mouseup)}var startX=0,startY=0,x=0,y=0;element.find(".panel-heading").on("mousedown",function(e){e.preventDefault(),y=1*element.css("top").replace("px",""),x=1*element.css("left").replace("px",""),startX=e.screenX-x,startY=e.screenY-y,$document.on("mousemove",mousemove),$document.on("mouseup",mouseup)})}}}]),angular.module("core").directive("lpaTitle",[function(){return{restrict:"E",transclude:!0,scope:{code:"@"},templateUrl:"modules/core/directives/views/title.client.view.html"}}]),angular.module("core").factory("d3",function(){return d3}),angular.module("core").service("Menus",[function(){this.defaultRoles=["*"],this.menus={};var shouldRender=function(user){if(!user)return this.isPublic;if(~this.roles.indexOf("*"))return!0;for(var userRoleIndex in user.roles)for(var roleIndex in this.roles)if(this.roles[roleIndex]===user.roles[userRoleIndex])return!0;return!1};this.validateMenuExistance=function(menuId){if(menuId&&menuId.length){if(this.menus[menuId])return!0;throw new Error("Menu does not exists")}throw new Error("MenuId was not provided")},this.getMenu=function(menuId){return this.validateMenuExistance(menuId),this.menus[menuId]},this.addMenu=function(menuId,isPublic,roles){return this.menus[menuId]={isPublic:isPublic||!1,roles:roles||this.defaultRoles,items:[],shouldRender:shouldRender},this.menus[menuId]},this.removeMenu=function(menuId){this.validateMenuExistance(menuId),delete this.menus[menuId]},this.addMenuItem=function(menuId,menuItemTitle,menuItemURL,menuItemState,isPublic,roles,menuItemType,position){return this.validateMenuExistance(menuId),this.menus[menuId].items.push({title:menuItemTitle,link:menuItemURL,menuItemType:menuItemType||"item",menuItemClass:menuItemType,state:menuItemState||menuItemURL,isPublic:null===isPublic||"undefined"==typeof isPublic?this.menus[menuId].isPublic:isPublic,roles:null===roles||"undefined"==typeof roles?this.menus[menuId].roles:roles,position:position||0,items:[],shouldRender:shouldRender}),this.menus[menuId]},this.addSubMenuItem=function(menuId,rootMenuItemURL,menuItemTitle,menuItemURL,menuItemState,isPublic,roles,position){this.validateMenuExistance(menuId);for(var itemIndex in this.menus[menuId].items)this.menus[menuId].items[itemIndex].link===rootMenuItemURL&&this.menus[menuId].items[itemIndex].items.push({title:menuItemTitle,link:menuItemURL,state:menuItemState||menuItemURL,isPublic:null===isPublic||"undefined"==typeof isPublic?this.menus[menuId].items[itemIndex].isPublic:isPublic,roles:null===roles||"undefined"==typeof roles?this.menus[menuId].items[itemIndex].roles:roles,position:position||0,shouldRender:shouldRender});return this.menus[menuId]},this.removeMenuItem=function(menuId,menuItemURL){this.validateMenuExistance(menuId);for(var itemIndex in this.menus[menuId].items)this.menus[menuId].items[itemIndex].link===menuItemURL&&this.menus[menuId].items.splice(itemIndex,1);return this.menus[menuId]},this.removeSubMenuItem=function(menuId,submenuItemURL){this.validateMenuExistance(menuId);for(var itemIndex in this.menus[menuId].items)for(var subitemIndex in this.menus[menuId].items[itemIndex].items)this.menus[menuId].items[itemIndex].items[subitemIndex].link===submenuItemURL&&this.menus[menuId].items[itemIndex].items.splice(subitemIndex,1);return this.menus[menuId]},this.addMenu("topbar",!0)}]),angular.module("core").service("Messenger",["$filter",function($filter){Messenger.options={extraClasses:"messenger-fixed messenger-on-bottom messenger-on-right",theme:"future"};var _messenger=new Messenger,message=function(msg){var args=Array.prototype.slice.call(arguments,1);return msg=$filter("translate")(msg||"NO_MESSAGE"),msg.replace(/{(\d+)}/g,function(m,n){return"undefined"!=typeof args[n]?args[n]:m})};this.post=function(msg,type){_messenger.post({message:message(msg,Array.prototype.slice.call(arguments,2)),type:type||"error",showCloseButton:!0})}}]),angular.module("protocols").run(["Menus",function(Menus){Menus.addMenuItem("topbar","PROTOCOLS_LIST","protocols","listProtocols"),Menus.addMenuItem("topbar","PROTOCOLS_NEW","protocols/create","createProtocol",!1)}]),angular.module("protocols").config(["$stateProvider",function($stateProvider){$stateProvider.state("listProtocols",{url:"/protocols",templateUrl:"modules/protocols/views/list-protocols.client.view.html"}).state("createProtocol",{url:"/protocols/create",templateUrl:"modules/protocols/views/create-protocol.client.view.html"}).state("viewProtocol",{url:"/protocols/:protocolId",templateUrl:"modules/protocols/views/view-protocol.client.view.html"}).state("forkProtocol",{url:"/protocols/:protocolId/fork",templateUrl:"modules/protocols/views/edit-protocol.client.view.html"})}]),angular.module("protocols").controller("ProtocolsController",["$scope","$stateParams","$location","$timeout","$filter","$modal","Authentication","Protocols","Graph","Actions","Messenger","$analytics",function($scope,$stateParams,$location,$timeout,$filter,$modal,Authentication,Protocols,Graph,Actions,Messenger,$analytics){$scope.authentication=Authentication,$scope.selected={index:0},$scope.actions=Actions,$scope.$watch(function(){return Actions.nodeSettings},function(){$scope.nodeSettings=Actions.nodeSettings,$scope.nodeSettings.node&&$scope.nodeSettings.node.rebuild&&$scope.nodeSettings.node.rebuild()},!0),$scope.$watch(function(){return Actions.linkSettings},function(){$scope.linkSettings=Actions.linkSettings,$scope.linkSettings.link&&$scope.linkSettings.link.rebuild&&$scope.linkSettings.link.rebuild()},!0),$scope.openSettings=function(){var modalInstance=$modal.open({templateUrl:"modules/protocols/views/modals/create-protocol.client.modal.html",controller:"ProtocolsModalController",resolve:{protocol:function(){return $scope.protocol}}});modalInstance.result.then(function(protocol){$scope.protocol=protocol},function(){$scope.protocol&&$scope.protocol.title||Messenger.post("NO_PROTOCOL_TITLE","error")})},$scope.saveProtocol=function(){if(!$scope.protocol||!$scope.protocol.title)return void Messenger.post("NO_PROTOCOL_TITLE","error");var protocol=new Protocols({title:$scope.protocol.title,processes:{},finalstatemachines:[]});Graph.instances.forEach(function(instance){var graph=instance.data();graph.type===Graph.TYPE.PROCESSES?protocol.processes=graph:protocol.finalstatemachines.push(graph)}),protocol.$save(function(response){$location.path("protocols/"+response._id)},function(errorResponse){Messenger.post(errorResponse.data.message,"error")})},$scope["import"]=function(fileInput){var file=fileInput.files&&fileInput.files.length>0&&fileInput.files[0],callback=function(protocol){var errors=0;return void 0===protocol.finalstatemachines&&(Messenger.post("IMPORT_ERR_FSM","error"),errors+=1),void 0===protocol.processes&&(Messenger.post("IMPORT_ERR_PROCESSES","error"),errors+=1),errors>0?!1:($scope.graphs=[],Graph.destroy(),$scope.$apply(),$scope.protocol=protocol,$scope.graphs=protocol.finalstatemachines||[],$scope.graphs.unshift(protocol.processes),$scope.$apply(),$timeout(function(){$scope.graphs=Graph.instances},0),!0)};if(file&&"application/json"===file.type){Messenger.post("IMPORT_FILE_SUCCESS","success",file.name);var readFile=new FileReader;readFile.onload=function(e){try{callback(JSON.parse(e.target.result))&&Messenger.post("IMPORT_FILE_PARSE_SUCCESS","success",file.name)}catch(error){Messenger.post("IMPORT_FILE_PARSE_ERROR","error",error.toLocaleString())}},readFile.readAsText(file)}else Messenger.post("IMPORT_FILE_ERROR","error",file&&file.name);angular.element(fileInput).val("")},$scope["export"]=function($event){var protocol={title:$scope.protocol.title,processes:{},finalstatemachines:[]};Graph.instances.forEach(function(instance){var graph=instance.data();graph.type===Graph.TYPE.PROCESSES?protocol.processes=graph:protocol.finalstatemachines.push(graph)}),angular.element($event.target).attr("download",protocol.title+".json").attr("href","data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(protocol)))},$scope.exportSvg=function($event){var url,source,svg=angular.element.find("svg:visible");if(svg=angular.element(svg).clone(),angular.element(svg).find("rect.overlay").remove().length>0){var minX=0,maxX=0,maxY=0;angular.element(svg).find("g.node").each(function(i,node){var tmp=angular.element(node).attr("transform").split(/[^\-0-9.]{1,}/);tmp[1]=parseFloat(tmp[1]),tmp[2]=parseFloat(tmp[2]),tmp[1]<minX&&(minX=tmp[1]),tmp[1]>maxX&&(maxX=tmp[1]),tmp[2]>maxY&&(maxY=tmp[2])}),angular.element(svg).attr("width",maxX-minX+300).attr("height",maxY+200).children("g").attr("transform","translate("+(-1*minX+150)+", 50)").children("g").attr("transform","")}source=(new XMLSerializer).serializeToString(svg[0]),source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)||(source=source.replace(/^<svg/,'<svg xmlns="http://www.w3.org/2000/svg"')),source.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)||(source=source.replace(/^<svg/,'<svg xmlns:xlink="http://www.w3.org/1999/xlink"')),source='<?xml version="1.0" standalone="no"?>\r\n'+source,url="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(source),angular.element($event.target).attr("download",$scope.protocol.title+".svg").attr("href",url)},$scope.create=function(){$scope.openSettings(),Graph.destroy(),$scope.graphs=Graph.instances,angular.forEach(Graph.LINK_TYPE,function(value,key){"UNKNOWN"!==key&&this.push({id:key,text:value})},$scope.linkTypes=[]),Graph.empty({type:Graph.TYPE.PROCESSES,title:$filter("translate")("PROCESS_LIST")}),$analytics.eventTrack("lpa.protocols.create",{category:"protocols",label:"Create"})},$scope["delete"]=function(protocolId){$scope.protocol=Protocols["delete"]({protocolId:protocolId||$stateParams.protocolId},function(protocol){var index;$scope.protocols.forEach(function(protocol_,index_){protocol._id===protocol_._id&&(index=index_)}),$scope.protocols.splice(index,1)},function(error){Messenger.post(error.data.message,"error")}),$analytics.eventTrack("lpa.protocols.view",{category:"protocols",label:"Delete"})},$scope.view=function(){Graph.destroy(),$scope.protocol=Protocols.get({protocolId:$stateParams.protocolId}),$analytics.eventTrack("lpa.protocols.view",{category:"protocols",label:"View"})},$scope.edit=function(){Graph.destroy(),Protocols.get({protocolId:$stateParams.protocolId},function(protocol){$scope.protocol=protocol,$scope.graphs=protocol.finalstatemachines||[],$scope.graphs.unshift(protocol.processes),$timeout(function(){$scope.graphs=Graph.instances},0)}),angular.forEach(Graph.LINK_TYPE,function(value,key){"UNKNOWN"!==key&&this.push({id:key,text:value})},$scope.linkTypes=[]),$analytics.eventTrack("lpa.protocols.edit",{category:"protocols",label:"Edit"})},$scope.list=function(){$scope.protocols=Protocols.query(),$analytics.eventTrack("lpa.protocols.list",{category:"protocols",label:"List"})},$scope.analyze=function(protocol){$scope.alerts=[],protocol?protocol.title?protocol.processes&&protocol.finalstatemachines||(protocol.processes={},protocol.finalstatemachines=[],Graph.instances.forEach(function(instance){var graph=instance.data();graph.type===Graph.TYPE.PROCESSES?protocol.processes=graph:protocol.finalstatemachines.push(graph)})):$scope.alerts.push({type:"danger",msg:"No protocol title defined."}):$scope.alerts.push({type:"danger",msg:"No protocol defined."}),$scope.p=protocol,$scope.startAnalyze=$scope.startAnalyze&&++$scope.startAnalyze||1}}]),angular.module("protocols").controller("ProtocolsModalController",["$scope","$modalInstance","protocol",function($scope,$modalInstance,protocol){$scope.protocol=protocol,$scope.save=function(){$scope.protocol&&$scope.protocol.title&&$scope.protocol.title.length>3?$modalInstance.close($scope.protocol):$scope.error="PROTOCOL_TITLE_ERR"},$scope.close=function(){$modalInstance.dismiss("cancel")}}]),angular.module("protocols").directive("analysis",function(){return{restrict:"E",scope:{protocol:"=",analyze:"="},templateUrl:"modules/protocols/directives/views/analysis.client.directive.view.html",controller:["$scope","Analysis",function($scope,Analysis){$scope.analysis=Analysis,$scope.$watch(function(){return $scope.analyze},function(analyze){analyze&&$scope.analysis.drawTree($scope.protocol)}),$scope.isFullScreen=!1,$scope.fullScreen=function($event){angular.element($event.target).parents(".tab-pane.active").toggleClass("full-screen"),$scope.isFullScreen=!$scope.isFullScreen}}],link:function($scope,elm,attrs){$scope.analysis.init(elm[0].querySelector(".tree-content"))}}}),angular.module("protocols").directive("graph",[function(){return{restrict:"E",scope:{graphData:"=",edit:"="},templateUrl:"modules/protocols/directives/views/graph.client.directive.view.html",controller:["$scope","Graph",function($scope,Graph){$scope.graph=new Graph.instance,$scope.gravity=!0,$scope.toggleGravity=function(){$scope.gravity=!$scope.graph.toggleGravity()},$scope.nodeType=Graph.NODE_TYPE[$scope.graphData.type]}],link:function($scope,elm,attrs){$scope.graphData&&$scope.graphData.$promise?$scope.graphData.$promise.then(function(graphData){graphData&&$scope.graph.init(elm[0].querySelector(".graph-content"),graphData.processes)}):$scope.graph.init(elm[0].querySelector(".graph-content"),$scope.graphData)}}}]),angular.module("protocols").directive("protocol",[function(){return{restrict:"E",transclude:!0,templateUrl:"modules/protocols/directives/views/protocol.client.directive.view.html"}}]),angular.module("protocols").filter("processFilter",function(){return function(items,props){var out=[];return angular.isArray(items)?items.forEach(function(item){item.values&&"PROCESSES"===item.values.type&&item.values.data.nodes.forEach(function(node){props&&props.parentNodeId&&node.nodeId!==props.parentNodeId&&out.push(node)})}):out=items,out}}).filter("processName",["Graph",function(Graph){return function(item){var name;return"string"==typeof item?Graph.instances.forEach(function(graph){graph.values&&"PROCESSES"===graph.values.type&&graph.values.data.nodes.forEach(function(node){node.nodeId===item&&(name=node.title)})}):name=item?item.label:"_",name}}]).filter("linkTypeName",["Graph",function(Graph){return function(item){return"string"==typeof item?Graph.LINK_TYPE[item]:item&&item.text}}]),angular.module("protocols").service("Actions",["$timeout","Messenger",function($timeout,Messenger){this.nodeSettings={visible:!1},this.linkSettings={visible:!1},this.showNodeSettings=function(options){var this_=this;options=options||{},options.visible=!0,$timeout(function(){this_.nodeSettings=options},0)},this.hideNodeSettings=function(){var this_=this;$timeout(function(){this_.nodeSettings.visible=!1},0)},this.showLinkSettings=function(options){var this_=this;options=options||{},options.visible=!0,$timeout(function(){this_.linkSettings=options},0)},this.hideLinkSettings=function(){var this_=this;$timeout(function(){this_.linkSettings.visible=!1},0)}}]),angular.module("protocols").factory("Analysis",["d3","$window","Graph","Messenger",function(d3,$window,Graph,Messenger){function resize(){var w=angular.element(".container > section").prop("offsetWidth"),h=2e3;graph.tree.size([w,h]),graph.treeSvg.attr("width",w).attr("height",h),graph.overlay.attr("width",w).attr("height",h)}function click(node_){node_.children?(node_._children=node_.children,node_.children=null):node_._children&&(node_.children=node_._children,node_._children=null),update(node_)}function creatTextNode(d3node,value){d3node.selectAll("g").data([value]).enter().append("svg:g").attr("class","text-tree-node").attr("text-anchor","middle").each(function(d){d3.select(this).append("svg:circle").attr("stroke","#333").attr("fill","#fff").attr("stroke-width","2px").attr("r",22).attr("cx","2px").attr("cy","22px"),d3.select(this).append("svg:text").attr("font-family","sans-serif").attr("font-size","14px").attr("dx","2px").attr("dy","28px").text(d)})}function createNode(d3node,node_){node_.grid={data:[],item:{size:node.size,startX:node.procNum*node.size/-2,startY:0,step:node.size}},node_.grid.item.posX=node_.grid.item.startX,node_.grid.item.posY=node_.grid.item.startY;for(var i=0;i<node.procNum*node.procNum;i++)Math.floor(i/node.procNum)===i%node.procNum?(node_.value=node_.processes[i%node.procNum].currrentFsmNode.label,node_.process=node_.processes[i%node.procNum].label):(node_.value=node_.processes[i%node.procNum].queue.values.join(", "),node_.process=null),node_.grid.data.push({time:i,value:node_.value,process:node_.process,width:node_.grid.item.size,height:node_.grid.item.size,x:node_.grid.item.posX,y:node_.grid.item.posY,count:i+1}),node_.grid.item.posY+=node_.grid.item.step,(i+1)%node.procNum===0&&(node_.grid.item.posY=node_.grid.item.startY,node_.grid.item.posX+=node_.grid.item.step);d3node.selectAll("g").data(node_.grid.data).enter().append("svg:g").attr("text-anchor","middle").each(function(d){d3.select(this).append("svg:rect").attr("class","cell").attr("fill","#fff").attr("stroke","#333").attr("x",function(d){return d.x}).attr("y",function(d){return d.y}).attr("width",function(d){return d.width}).attr("height",function(d){return d.height}),d3.select(this).append("svg:text").attr("x",function(d){return d.x+d.width/2}).attr("y",function(d){return d.y}).attr("dy","20px").text(function(d){return d.value||""}),d3.select(this).append("svg:text").attr("class","process").attr("text-anchor","start").attr("fill","#A7A7A7").attr("x",function(d){return d.x}).attr("y",function(d){return d.y}).attr("dy","28px").attr("dx","2px").text(function(d){return d.process||""})})}function update(source){graph.tree.nodeSize([node.size*source.processes.length+30,node.size*source.processes.length+130]);var nodes=graph.tree.nodes(graph.root).reverse(),links=graph.tree.links(nodes);nodes.forEach(function(d){d.y=150*d.depth});var node_=graph.svg.selectAll("g.node").data(nodes,function(d){return d.id});node_.enter().append("g").attr("class","node").attr("width",function(){return node.procNum*node.size}).attr("height",function(){return node.procNum*node.size}).attr("transform",function(d){return"translate("+source.x0+","+source.y0+")"}).each(function(d){switch(d.typeId){case NODE_TYPE.QUEUE_FULL:creatTextNode(d3.select(this),"PV");break;case NODE_TYPE.UNDEFINED_RECEIVE:creatTextNode(d3.select(this),"NS");break;case NODE_TYPE.REPEATING:creatTextNode(d3.select(this),getTreeNode(d.repeatingNodeId).normalNodeId);break;default:createNode(d3.select(this),d),d3.select(this).append("svg:text").attr("x",function(){return node.procNum*node.size/-2}).attr("dy","-5px").text(function(d){return getTreeNode(d.id).normalNodeId}),d3.select(this).on("click",click)}d3.select(this).append("svg:text").attr("dx","10px").attr("dy","-5px").text(function(d){return d.action})}),node_.transition().duration(duration).attr("transform",function(d){return"translate("+d.x+","+d.y+")"}),node_.exit().transition().duration(duration).attr("transform",function(d){return"translate("+source.x+","+source.y+")"}).remove();var link=graph.svg.selectAll("path.tree-link").data(links,function(d){return d.target.id});link.enter().insert("path","g").attr("class","tree-link").attr("fill","none").attr("stroke","#333").attr("stroke-width","2px").attr("d",function(d){var o={x:source.x0,y:source.y0};return graph.diagonal({source:o,target:o})}),link.transition().duration(duration).attr("d",graph.diagonal),link.exit().transition().duration(duration).attr("d",function(d){var o={x:source.x,y:source.y};return graph.diagonal({source:o,target:o})}).remove(),nodes.forEach(function(d){d.x0=d.x,d.y0=d.y})}function getProcessFsmLinks(process){var fsmLinks=[];return graph.protocol.finalstatemachines.forEach(function(fsm){process.nodeId===fsm.parentNodeId&&(fsmLinks=fsm.links)}),fsmLinks}function getParentTreeProcess(parentTreeNode,processId){var parent;return parentTreeNode.processes.forEach(function(process){process.nodeId===processId&&(parent=process)}),parent}function getProcess(processId){var process_;return graph.protocol.processes.nodes.forEach(function(process){process.nodeId===processId&&(process_=process)}),process_}function addToQueue(parentTreeNode,processId,msg){var isAdded=!1;return graph.protocol.processes.nodes.forEach(function(processNode){processNode.nodeId===processId&&processNode.queue.values.length<processNode.queue.length&&(processNode.queue.values.push(msg),isAdded=!0)}),isAdded}function removeFromQueue(parentTreeNode,processId,msg){var isRemoved=!1;return graph.protocol.processes.nodes.forEach(function(processNode){if(processNode.nodeId===processId){var index=processNode.queue.values.indexOf(msg);index>=0&&(processNode.queue.values.splice(index,1),isRemoved=!0)}}),isRemoved}function transformFsmNode(node_){return{nodeId:node_.nodeId,label:node_.label}}function transformProcessNode(process){return{nodeId:process.nodeId,label:process.label,currrentFsmNode:transformFsmNode(process.currrentFsmNode),queue:{values:process.queue.values.slice(),length:process.queue.length}}}function compareTreeNodes(node1,node2){var count=0;return node1.typeId===NODE_TYPE.NORMAL&&node2.typeId===NODE_TYPE.NORMAL&&node1.processes.forEach(function(p1){node2.processes.forEach(function(p2){p1.nodeId===p2.nodeId&&angular.equals(p1.queue,p2.queue)&&p1.currrentFsmNode.nodeId===p2.currrentFsmNode.nodeId&&count++})}),node1.processes.length===node2.processes.length&&node1.processes.length===count}function isTreeNodeExists(currentTreeNode,treeNode){var index=-1;if(compareTreeNodes(currentTreeNode,treeNode))index=currentTreeNode.id;else if(currentTreeNode.children&&currentTreeNode.children.length>0)for(var i=0;i<currentTreeNode.children.length&&!((index=isTreeNodeExists(currentTreeNode.children[i],treeNode))>0);i++);return index}function createTreeNode(options){options=options||{};var treeNode={id:++graph.nodesCount-1,processes:[],typeId:options.typeId||NODE_TYPE.NORMAL,action:options.action||"",level:options.level};return graph.protocol.processes.nodes.forEach(function(process){treeNode.processes.push(transformProcessNode(process))}),graph.root&&(treeNode.repeatingNodeId=isTreeNodeExists(graph.root,treeNode))>=0&&(treeNode.typeId=NODE_TYPE.REPEATING),treeNode.typeId===NODE_TYPE.NORMAL&&(treeNode.normalNodeId=++graph.normalNodesCount-1),treeNode}function addChildNode(parentTreeNode,options){parentTreeNode.children=parentTreeNode.children||[],parentTreeNode.children.push(createTreeNode(options))}function treeNodes(parent,node,childs){parent&&(node(parent),childs(parent).forEach(function(child){treeNodes(child,node,childs)}))}function getTreeNodes(level,typeId){var nodes=[];return treeNodes(graph.root,function(node){node.level===level&&node.typeId===typeId&&nodes.push(node)},function(d){return d.children&&d.children.length>0?d.children:[]}),nodes}function getTreeNode(id){var node;return treeNodes(graph.root,function(node_){node_.id===id&&(node=node_)},function(d){return d.children&&d.children.length>0?d.children:d._children&&d._children.length>0?d._children:[]}),node}function researchLevel(parentTreeNode,level,isLast){if(graph.protocol.processes.nodes.forEach(function(process){getProcessFsmLinks(process).forEach(function(link){if(process.currrentFsmNode=getParentTreeProcess(parentTreeNode,process.nodeId).currrentFsmNode,process.currrentFsmNode.nodeId===link.source.nodeId){var action=process.label+": "+Graph.LINK_TYPE[link.typeId]+link.name+(link.processId&&"("+getProcess(link.processId).label+")"||"");switch(graph.protocol.processes.nodes.forEach(function(process_){var parent=getParentTreeProcess(parentTreeNode,process_.nodeId);process_.currrentFsmNode=parent.currrentFsmNode,process_.queue.values=parent.queue.values.slice()}),link.typeId){case"SEND":addToQueue(parentTreeNode,link.processId,link.name)?(process.currrentFsmNode=link.target,addChildNode(parentTreeNode,{action:action,level:level})):addChildNode(parentTreeNode,{typeId:NODE_TYPE.QUEUE_FULL,action:action,level:level});break;case"RECEIVE":removeFromQueue(parentTreeNode,process.nodeId,link.name)?(process.currrentFsmNode=link.target,addChildNode(parentTreeNode,{action:action,level:level})):getParentTreeProcess(parentTreeNode,process.nodeId).queue.values.length>0&&addChildNode(parentTreeNode,{typeId:NODE_TYPE.UNDEFINED_RECEIVE,action:action,level:level});break;case"LOCAL":process.currrentFsmNode=link.target,addChildNode(parentTreeNode,{action:action,level:level})}}})}),isLast){var children=getTreeNodes(level,NODE_TYPE.NORMAL);children.forEach(function(treeChildNode,index){treeChildNode.typeId===NODE_TYPE.NORMAL&&researchLevel(treeChildNode,level+1,index===children.length-1)})}}function collapseAllNodes(){graph.svg.selectAll("g.node").each(function(d,i){var onClickFunc=(d3.select(this).data(),d3.select(this).on("click"));onClickFunc&&d3.select(this).data()[0].children&&onClickFunc.apply(this,[d,i])})}function drawGraph(protocol){return graph.protocol=protocol,graph.error=!1,graph.nodesCount=0,graph.normalNodesCount=0,graph.root=null,graph.protocol?graph.protocol.processes&&graph.protocol.processes.nodes&&graph.protocol.processes.nodes.length?(node.procNum=graph.protocol.processes.nodes.length,graph.protocol.processes.nodes.forEach(function(process,index){graph.protocol.finalstatemachines.forEach(function(fsm){process.nodeId===fsm.parentNodeId&&fsm.nodes.forEach(function(node_){"START_STATE"===node_.type&&(process.currrentFsmNode=transformFsmNode(node_))})}),process.currrentFsmNode||(Messenger.post("MISSING_START_STATE","error",process.label),graph.error=!0),process.queue={length:process.queueLength,values:[]}}),void(graph.error||(resize(),graph.root=createTreeNode(),graph.root.x0=graph.treeSvg.attr("width")/2,graph.root.y0=0,researchLevel(graph.root,0,!0),update(graph.root)))):void Messenger.post("PROTOCOL_HAS_NO_PROCESSES","error"):void Messenger.post("NO_PROTOCOL_TO_ANALYZE","error")}function init(element_){var width=5e3,height=1e3;element=element_,graph.tree=d3.layout.tree().size([width,height]),graph.diagonal=d3.svg.diagonal().source(function(d){return{x:d.source.x,y:d.source.y+node.procNum*node.size}}).target(function(d){return{x:d.target.x,y:d.target.y}}).projection(function(d){return[d.x,d.y]}),graph.treeSvg=d3.select(element_).append("svg").attr("width",width).attr("height",height),graph.svg=graph.treeSvg.append("g").attr("transform","translate(0, 50)").call(d3.behavior.zoom().scaleExtent([-1,8]).on("zoom",function(){graph.svg.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")})),graph.overlay=graph.svg.append("rect").attr("class","overlay").attr("fill","none").attr("width",width).attr("height",height),graph.svg=graph.svg.append("g"),angular.element($window).bind("resize",resize)}var graph={svg:null,overlay:null,tree:null,treeSvg:null,protocol:null,root:null,diagonal:null,nodesCount:0,normalNodesCount:0,error:!1},element=null,node={procNum:0,size:30},duration=500,NODE_TYPE={QUEUE_FULL:"QUEUE_FULL",UNDEFINED_RECEIVE:"UNDEFINED_RECEIVE",REPEATING:"REPEATING",NORMAL:"NORMAL"};return{init:init,drawTree:drawGraph,collapseAllNodes:collapseAllNodes}}]),angular.module("protocols").factory("Graph",["$filter","d3","Messenger","Actions",function($filter,d3,Messenger,Actions){function nodeData(node){return node[0][0].parentNode.__data__}function random(min,max){return Math.floor(Math.random()*(max-min+1)+min)}function label(i,type){var label_="";return angular.isNumber(i)?angular.forEach(i.toString().replace("-","").split(""),function(value){value=parseInt(value),label_+=type===GRAPH.TYPE.PROCESSES?PROC_LABEL_TRANSLATOR[value%PROC_LABEL_TRANSLATOR.length]:type===GRAPH.TYPE.FINAL_STATE_MACHINE?FSM_LABEL_TRANSLATOR[value%FSM_LABEL_TRANSLATOR.length]:LABEL_TRANSLATOR[value%LABEL_TRANSLATOR.length]}):label_=i,label_}function uid(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=16*Math.random()|0,v="x"===c?r:3&r|8;return v.toString(16)})}function Graph(){this.values={type:null,title:null,parentNodeId:null,force:null,svg:{nodes:[],links:[],selected:{node:null,link:null},start:{node:null}},data:{nodes:[],links:[],start:{node:null}}},graphsCount>graphs.length?graphs[graphs.length-1]=this:(graphs.push(this),graphsCount++)}function updateGraphTitle(parentNodeId,title){for(var i=0;i<graphs.length;i++)graphs[i].values&&graphs[i].values.parentNodeId===parentNodeId&&(graphs[i].values.title=title)}function createNewGraph(options){graphsCount+=2,graphs.push(options)}function removeGraph(graphIndex){graphs.splice(graphIndex,1),graphsCount--}function destroy(){graphs.splice(0,graphs.length),graphsCount=0}function processById(id){for(var process={},i=0;i<graphs.length;i++)if(graphs[i].values&&graphs[i].values.type===GRAPH.TYPE.PROCESSES)for(var j=graphs[i].values.data.nodes.length-1;j>=0;j--)if(graphs[i].values.data.nodes[j].nodeId===id){process=graphs[i].values.data.nodes[j];break}return process}var graphs=[],graphsCount=0,isGravityZero=!1,radius=d3.scale.sqrt().range([0,6]),LINKDISTANCE=250,PROC_LABEL_TRANSLATOR="PABC".split(""),FSM_LABEL_TRANSLATOR="xyz".split(""),LABEL_TRANSLATOR="abcdefghijklmn".split(""),GRAPH={TYPE:{PROCESSES:"PROCESSES",FINAL_STATE_MACHINE:"FINAL_STATE_MACHINE"},NODES:{PROCESSES:"PROCESS",FINAL_STATE_MACHINE:"ACCEPT_STATE"}},LINKS={TYPE:{
UNKNOWN:"_",RECEIVE:"+",SEND:"-",LOCAL:"#"}},NODES={TYPE:{PROCESS:"PROCESS",START_STATE:"START_STATE",ACCEPT_STATE:"ACCEPT_STATE"},SIZE:{PROCESS:14,START_STATE:12,ACCEPT_STATE:12},COLOR:{PROCESS:"#DDD",START_STATE:"#DDD",ACCEPT_STATE:"#DDD"},STROKE_WIDTH:{PROCESS:1,START_STATE:2,ACCEPT_STATE:1,SELECTED:3},STROKE:{PROCESS:"#000",START_STATE:"#F00",ACCEPT_STATE:"#000",SELECTED:"#337ab7"}};return Graph.prototype.data=function(){return{title:this.values.title,type:this.values.type,parentNodeId:this.values.parentNodeId,nodes:this.values.data.nodes,links:this.values.data.links}},Graph.prototype.build=function(){var this_=this,nodeClicked=function(node){this_.values.svg.selected.node&&this_.values.svg.selected.node.style("stroke-width",function(d){return NODES.STROKE_WIDTH[d.type]}).style("stroke",function(d){return NODES.STROKE[d.type]}),this_.values.svg.selected.node&&this_.values.svg.selected.node.data()[0].nodeId===d3.select(this).data()[0].nodeId?this_.values.svg.selected.node=null:this_.values.svg.selected.node=d3.select(this).select("circle").style("stroke-width",function(d){return NODES.STROKE_WIDTH.SELECTED}).style("stroke",function(d){return NODES.STROKE.SELECTED})},nodeDblClicked=function(node){Actions.showNodeSettings({style:{top:80,left:100},node:node,graph:this_.data()}),this_.temp=this_.temp||{},this_.temp.currentNode=d3.select(this)},labelClick=function(link){Actions.showLinkSettings({style:{top:80,left:10},link:link,graph:this_.data()}),this_.temp=this_.temp||{},this_.temp.currentLink=d3.select(this)};this_.values.svg.nodes=this_.values.svg.nodes.data(this_.values.force.nodes(),function(d){return d.nodeId}),this_.values.svg.nodes.enter().append("svg:g").attr("class","node").each(function(d){d3.select(this).append("svg:circle").attr("class",function(d){return"node "+d.nodeId}).attr("r",function(d){return radius(NODES.SIZE[d.type])}).style("stroke-width",function(d){return NODES.STROKE_WIDTH[d.type]}).style("stroke",function(d){return NODES.STROKE[d.type]}).style("fill",function(d){return NODES.COLOR[d.type]}),d3.select(this).append("svg:text").attr("dy",".35em").attr("text-anchor","middle").attr("font-family","sans-serif").attr("font-size","10px").text(function(d,i){return d.label||i}),d3.select(this).on("click",nodeClicked).on("dblclick",nodeDblClicked),d3.select(this).call(this_.values.force.drag)}),this_.values.svg.nodes.exit().remove(),this_.values.svg.links=this_.values.svg.links.data(this_.values.force.links(),function(d){return d.source.nodeId+"-"+d.target.nodeId+"-"+(d.linkNum||1)}),this_.values.svg.links.enter().insert("svg:g",":first-child").attr("class","link").each(function(d){d3.select(this).append("svg:path").attr("class","link").attr("fill","none").attr("stroke","#666").attr("stroke-width","3px").attr("id",function(d){return"link-"+d.source.nodeId+"-"+d.target.nodeId+"-"+(d.linkNum||1)}).attr("marker-end",this_.values.type===GRAPH.TYPE.PROCESSES?"":"url(#end)"),d3.select(this).append("svg:text").attr("class","linklabel").attr("dx",LINKDISTANCE/2).attr("dy","-10").attr("text-anchor","middle").attr("font-size","15px").attr("fill","#333").append("svg:textPath").on("dblclick",labelClick).attr("xlink:href",function(d){return"#link-"+d.source.nodeId+"-"+d.target.nodeId+"-"+(d.linkNum||1)}).text(function(d){return d.label()})}),this_.values.svg.links.exit().remove(),this_.values.force.start()},Graph.prototype.nodeLinks=function(nodeId_){var links=[];return this.values.data.links.forEach(function(link){(link.source.nodeId===nodeId_||link.target.nodeId===nodeId_)&&links.push(link)}),links},Graph.prototype.addLink=function(options){options=options||{};var this_=this,addLink=function(source,target,options){options=options||{};var linkNum=1;this_.values.data.links.forEach(function(link){link.source===source&&link.target===target&&(linkNum+=1)}),source===target&&(linkNum=-1*linkNum),this_.values.data.links.push({source:source,target:target,typeId:options.typeId||"UNKNOWN",linkNum:linkNum,name:options.name||label(linkNum),processId:options.processId,label:function(){var label_="";return label_=this.source.type===NODES.TYPE.PROCESS&&this.target.type===NODES.TYPE.PROCESS?processById(this.source.nodeId).queueLength+"/"+processById(this.source.nodeId).queueLength:"LOCAL"===this.typeId?LINKS.TYPE[this.typeId]+this.name:LINKS.TYPE[this.typeId]+this.name+"("+(processById(this.processId).label||"_")+")"},rebuild:function(){this_.temp=this_.temp||{},this_.temp.currentLink.text(function(d){return d.label()})}}),this_.build()};return this_.temp=this_.temp||{},this_.values.svg.selected.node||options.targetNode||this_.temp.sourceNode?void(this_.temp.sourceNode&&this_.values.svg.selected.node||options.sourceNode?(options.targetNode?addLink(options.sourceNode,options.targetNode,options):(addLink(nodeData(this_.temp.sourceNode),nodeData(this_.values.svg.selected.node)),Messenger.post("Link added.","success")),this_.temp.sourceNode=null):(this_.values.svg.selected.node&&(this_.temp.sourceNode=this_.values.svg.selected.node),Messenger.post("Select target node and click add link.","info"))):void Messenger.post("Select source node and click add link.","info")},Graph.prototype.addNode=function(type,options){if(!type)return void Messenger.post("No type selected!","error");options=options||{};var this_=this,nodeLabel=label(this_.values.data.nodes.length+1,this_.values.type),node={nodeId:options.nodeId||uid(),label:options.label||nodeLabel,size:options.size||NODES.SIZE[type],type:options.type||NODES.TYPE[type],isStart:(options.type||NODES.TYPE[type])===NODES.TYPE.START_STATE,queueLength:options.queueLength||1,rebuild:function(){this_.temp=this_.temp||{},this_.temp.currentNode.select("text").text(function(d,i){return d.label||i}),node&&node.type===NODES.TYPE.PROCESS&&updateGraphTitle(node.nodeId,node.label)}};this_.values.type!==GRAPH.TYPE.PROCESSES||options.type?this_.values.type===GRAPH.TYPE.FINAL_STATE_MACHINE&&(node.setStartState=function(){this_.values.svg.start.node&&this_.values.data.start.node&&(this_.values.svg.start.node.style("stroke-width",function(d){return NODES.STROKE_WIDTH.ACCEPT_STATE}).style("stroke",function(d){return NODES.STROKE.ACCEPT_STATE}),this_.values.data.start.node.type=NODES.TYPE.ACCEPT_STATE,this_.values.data.start.node.isStart=!1),this_.values.svg.start.node=this_.values.svg.selected.node,this_.values.data.start.node=node,node.isStart||(this_.values.svg.start.node.style("stroke-width",function(d){return NODES.STROKE_WIDTH.START_STATE}).style("stroke",function(d){return NODES.STROKE.START_STATE}),this_.values.data.start.node.type=NODES.TYPE.START_STATE)}):createNewGraph({type:GRAPH.TYPE.FINAL_STATE_MACHINE,title:nodeLabel,parentNodeId:node.nodeId}),this_.values.data.nodes.push(node),this_.values.svg.selected.node?(node.x=nodeData(this_.values.svg.selected.node).x+random(-15,15),node.y=nodeData(this_.values.svg.selected.node).y+random(-15,15),this_.addLink({sourceNode:nodeData(this_.values.svg.selected.node),targetNode:node})):this_.build()},Graph.prototype.removeNode=function(){var this_=this;if(!this_.values.svg.selected.node)return void Messenger.post("NO_SELECTED_NODE","error");var nodeIndex,nodeId_=nodeData(this_.values.svg.selected.node).nodeId,nodeLinksIndexes=[];this_.values.data.nodes.forEach(function(node,index){node.nodeId===nodeId_&&(nodeIndex=index)}),this_.values.data.nodes.splice(nodeIndex,1),this_.values.data.links.forEach(function(link,index){this_.nodeLinks(nodeId_).forEach(function(nodeLink){nodeLink===link&&nodeLinksIndexes.push(index)})}),nodeLinksIndexes.sort(function(a,b){return b-a}).forEach(function(linkIndex){this_.values.data.links.splice(linkIndex,1)}),removeGraph(nodeIndex+1),this_.values.svg.selected.node=null,this_.build()},Graph.prototype.toggleGravity=function(element,options){return this.values.force.gravity(isGravityZero?.1:0),isGravityZero=!isGravityZero},Graph.prototype.init=function(element,options){options=options||{};var filter,feMerge,this_=this,svg=d3.select(element).append("svg").attr("width","100%").attr("height","100%"),defs=svg.append("svg:defs"),tick=function(){this_.values.svg.nodes.attr("transform",function(d){return"translate("+d.x+","+d.y+")"}),this_.values.svg.links.selectAll("path").attr("d",function(d){var sx=d.source.x,sy=d.source.y,tx=d.target.x,ty=d.target.y,dx=tx-sx,dy=ty-sy,dr=Math.sqrt(dx*dx+dy*dy),drx=dr,dry=dr,xRotation=0,largeArc=0,sweep=1;d.linkNum<0&&(xRotation=0,largeArc=1,drx=30+-10*d.linkNum,dry=30+-10*d.linkNum,tx+=1,ty+=1),drx/=d.linkNum||1,dry/=d.linkNum||1;return"M"+sx+","+sy+"A"+drx+","+dry+" "+xRotation+","+largeArc+","+sweep+" "+tx+","+ty})},resize=function(){this_.values.force.size([element.offsetWidth,element.offsetHeight]).resume()};filter=defs.append("svg:filter").attr("id","selected-element"),filter.append("svg:feGaussianBlur").attr("in","SourceAlpha").attr("stdDeviation",3).attr("result","blur"),filter.append("svg:feOffset").attr("in","blur").attr("result","offsetBlur"),feMerge=filter.append("svg:feMerge"),feMerge.append("svg:feMergeNode").attr("in","offsetBlur"),feMerge.append("svg:feMergeNode").attr("in","SourceGraphic"),defs.selectAll("marker").data(["end"]).enter().append("svg:marker").attr("id",String).attr("viewBox","0 -5 10 10").attr("refX",22).attr("refY",0).attr("markerWidth",6).attr("markerHeight",6).attr("orient","auto").append("svg:path").attr("d","M0,-5L10,0L0,5"),this_.values.data.nodes=[],this_.values.data.links=[],this_.values.force=d3.layout.force().nodes(this_.values.data.nodes).links(this_.values.data.links).charge(-400).linkDistance(LINKDISTANCE).on("tick",tick),resize(),d3.select(window).on("resize."+options._id||uid(),resize),this_.values.svg.nodes=svg.selectAll("g.node"),this_.values.svg.links=svg.selectAll("g.link"),this_.values.type=options.type,this_.values.title=options.title,this_.values.parentNodeId=options.parentNodeId,options.nodes=options.nodes||[],options.nodes.forEach(function(node){this_.addNode(node.type,{id:node._id,nodeId:node.nodeId,label:node.label,size:node.size,type:node.type,queueLength:node.queueLength})}),options.links=options.links||[],options.links.forEach(function(link,sourceNode,targetNode){sourceNode=null,targetNode=null,this_.values.data.nodes.forEach(function(node){node.nodeId===link.source.nodeId&&(sourceNode=node),node.nodeId===link.target.nodeId&&(targetNode=node)}),this_.addLink({sourceNode:sourceNode,targetNode:targetNode,typeId:link.typeId,name:link.name,processId:link.processId})})},{instance:Graph,instances:graphs,destroy:destroy,empty:createNewGraph,NODES:NODES,TYPE:GRAPH.TYPE,NODE_TYPE:GRAPH.NODES,LINK_TYPE:LINKS.TYPE}}]),angular.module("protocols").factory("Protocols",["$resource",function($resource){return $resource("protocols/:protocolId",{protocolId:"@_id"},{update:{method:"PUT"}})}]),angular.module("users").config(["$httpProvider",function($httpProvider){$httpProvider.interceptors.push(["$q","$location","Authentication",function($q,$location,Authentication){return{responseError:function(rejection){switch(rejection.status){case 401:Authentication.user=null,$location.path("signin");break;case 403:}return $q.reject(rejection)}}}])}]),angular.module("users").config(["$stateProvider",function($stateProvider){$stateProvider.state("profile",{url:"/settings/profile",templateUrl:"modules/users/views/settings/edit-profile.client.view.html"}).state("password",{url:"/settings/password",templateUrl:"modules/users/views/settings/change-password.client.view.html"}).state("signin",{url:"/signin",templateUrl:"modules/users/views/authentication/signin.client.view.html"}).state("forgot",{url:"/password/forgot",templateUrl:"modules/users/views/password/forgot-password.client.view.html"}).state("reset-invalid",{url:"/password/reset/invalid",templateUrl:"modules/users/views/password/reset-password-invalid.client.view.html"}).state("reset-success",{url:"/password/reset/success",templateUrl:"modules/users/views/password/reset-password-success.client.view.html"}).state("reset",{url:"/password/reset/:token",templateUrl:"modules/users/views/password/reset-password.client.view.html"}).state("users",{url:"/users",templateUrl:"modules/users/views/users/list-users.client.view.html"}).state("createUser",{url:"/users/create",templateUrl:"modules/users/views/users/create-user.client.view.html"}).state("editUser",{url:"/users/:userId",templateUrl:"modules/users/views/users/edit-user.client.view.html"})}]),angular.module("users").controller("AuthenticationController",["$scope","$http","$location","Authentication",function($scope,$http,$location,Authentication){$scope.authentication=Authentication,$scope.authentication.user&&$location.path("/"),$scope.signin=function(){$http.post("/auth/signin",$scope.credentials).success(function(response){$scope.authentication.user=response,$location.path("/")}).error(function(response){$scope.error=response.message})}}]),angular.module("users").controller("PasswordController",["$scope","$stateParams","$http","$location","Authentication",function($scope,$stateParams,$http,$location,Authentication){$scope.authentication=Authentication,$scope.authentication.user&&$location.path("/"),$scope.askForPasswordReset=function(){$scope.success=$scope.error=null,$http.post("/auth/forgot",$scope.credentials).success(function(response){$scope.credentials=null,$scope.success=response.message}).error(function(response){$scope.credentials=null,$scope.error=response.message})},$scope.resetUserPassword=function(){$scope.success=$scope.error=null,$http.post("/auth/reset/"+$stateParams.token,$scope.passwordDetails).success(function(response){$scope.passwordDetails=null,Authentication.user=response,$location.path("/password/reset/success")}).error(function(response){$scope.error=response.message})}}]),angular.module("users").controller("SettingsController",["$scope","$http","$location","Users","Authentication",function($scope,$http,$location,Users,Authentication){$scope.user=Authentication.user,$scope.user||$location.path("/"),$scope.hasConnectedAdditionalSocialAccounts=function(provider){for(var i in $scope.user.additionalProvidersData)return!0;return!1},$scope.isConnectedSocialAccount=function(provider){return $scope.user.provider===provider||$scope.user.additionalProvidersData&&$scope.user.additionalProvidersData[provider]},$scope.removeUserSocialAccount=function(provider){$scope.success=$scope.error=null,$http["delete"]("/users/accounts",{params:{provider:provider}}).success(function(response){$scope.success=!0,$scope.user=Authentication.user=response}).error(function(response){$scope.error=response.message})},$scope.updateUserProfile=function(isValid){if(isValid){$scope.success=$scope.error=null;var user=new Users($scope.user);user.$update(function(response){$scope.success=!0,Authentication.user=response},function(response){$scope.error=response.data.message})}else $scope.submitted=!0},$scope.changeUserPassword=function(){$scope.success=$scope.error=null,$http.post("/users/password",$scope.passwordDetails).success(function(response){$scope.success=!0,$scope.passwordDetails=null}).error(function(response){$scope.error=response.message})}}]),angular.module("users").controller("UsersController",["$scope","$http","$stateParams","$location","LpaUsers","Authentication","Messenger",function($scope,$http,$stateParams,$location,LpaUsers,Authentication,Messenger){$scope.authentication=Authentication,$scope.userRoles=[{name:"User",key:"user",value:!1},{name:"Administrator",key:"admin",value:!1}],$scope.create=function(){var lpaUser=new LpaUsers({firstName:this.firstName,lastName:this.lastName,email:this.email,username:this.username});lpaUser.$save(function(response){$location.path("users/"+response._id),$scope.firstName="",$scope.lastName="",$scope.username="",$scope.email=""},function(errorResponse){$scope.error=errorResponse.data.message})},$scope.update=function(){var lpaUser=$scope.lpaUser;lpaUser.roles=[],$scope.userRoles.forEach(function(role){role.value&&lpaUser.roles.push(role.key)}),lpaUser.$update(function(lpaUser){$scope.success=!0},function(errorResponse){$scope.error=errorResponse.data.message})},$scope.remove=function(lpaUser){var errorHandler=function(error){Messenger.post(error.data.message,"error")};lpaUser?lpaUser.$remove(function(){for(var i in $scope.lpaUsers)$scope.lpaUsers[i]===lpaUser&&$scope.lpaUsers.splice(i,1)},errorHandler):$scope.lpaUser.$remove(function(){$location.path("users")},errorHandler)},$scope.findOne=function(){$scope.lpaUser=LpaUsers.get({userId:$stateParams.userId},function(lpaUser){lpaUser.roles=lpaUser.roles||[],lpaUser.roles.forEach(function(role){$scope.userRoles.forEach(function(role2){role===role2.key&&(role2.value=!0)})})})},$scope.list=function(){$scope.lpaUsers=LpaUsers.query()},$scope.edit=function(lpaUser){$location.path("users/"+lpaUser._id)}}]),angular.module("users").factory("Authentication",["$window",function($window){var auth={user:$window.user,hasAuthorization:function(roles){var userRoles,this_=this,hasAuthorization=!1;return roles=roles||[],userRoles=this_.user&&this_.user.roles||[],angular.isArray(roles)||(roles=[roles]),roles.forEach(function(role){var hasRole=!1;return userRoles.forEach(function(role2){role===role2&&(hasRole=!0)}),hasRole?void(hasAuthorization=!0):hasAuthorization=!1}),hasAuthorization},checkUser:function(user){return user&&this.user&&user._id===this.user._id}};return auth}]),angular.module("users").factory("Users",["$resource",function($resource){return $resource("users",{},{update:{method:"PUT"}})}]).factory("LpaUsers",["$resource",function($resource){return $resource("users/:userId",{userId:"@_id"},{update:{method:"PUT"}})}]);